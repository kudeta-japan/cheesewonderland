<!doctype html>
<html lang="ja">
<head>
  <!-- =============================================
    Cheese Wonderland アンケート（Formspree版・A/B構成＋進行メーター）
    変更点：
      - 見出しを A. 全体評価 ／ B. 各アトラクション の2部構成に明確化
      - 進行メーター（どれくらいで終わるか）を再表示
      - アトラクション名を指定の5つに更新
      - ベスト3 → 1位/2位/3位 の順位選択（重複不可）
      - 名前・メール・お住まい・掲載可否は削除
  ============================================== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cheese Wonderland アンケート</title>
  <meta name="description" content="Cheese Wonderland ご参加者アンケート（所要2〜3分・匿名）" />
  <style>
    :root{ --bg:#0b0c10; --fg:#f7f7f7; --muted:#b5b5b5; --brand:#ffd54d; --brand2:#ffb300; --card:#14161a; --ok:#31c48d; }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; background:radial-gradient(1200px 800px at 70% -20%, rgba(255,213,77,.15), transparent), var(--bg); color:var(--fg);}
    .wrap{max-width:880px; margin:0 auto; padding:28px 18px 56px;}
    header{display:flex; align-items:center; gap:12px; margin-bottom:18px}
    .logo{width:40px; height:40px; border-radius:12px; background:linear-gradient(135deg,var(--brand),var(--brand2)); box-shadow:0 6px 18px rgba(255,181,0,.25);}
    h1{font-size: clamp(1.2rem, 2.4vw, 1.8rem); margin:0}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)); border:1px solid rgba(255,255,255,.06); box-shadow:0 10px 30px rgba(0,0,0,.25); border-radius:18px; padding:18px; margin:14px 0;}
    .muted{color:var(--muted); font-size:.95rem}
    .grid{display:grid; gap:12px}
    label{display:block; font-weight:600; margin:6px 0 8px}
    .help{color:var(--muted); font-size:.9rem}
    input[type="text"], select{ width:100%; background:#101217; color:var(--fg); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:12px 14px; font-size:1rem; outline:none; }
    .btns{display:flex; gap:10px; flex-wrap:wrap}
    button{cursor:pointer; border:0; padding:12px 16px; border-radius:12px; font-weight:700}
    .primary{background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#202020}
    .ghost{background:transparent; color:var(--fg); border:1px solid rgba(255,255,255,.14)}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#101217; border:1px solid rgba(255,255,255,.08); font-size:.9rem}
    .opt{display:flex; gap:8px; flex-wrap:wrap}
    .opt input[type="radio"]{display:none}
    .opt label{border:1px solid rgba(255,255,255,.14); padding:10px 12px; border-radius:12px; cursor:pointer; background:#101217}
    .opt input:checked + label{outline:2px solid var(--brand); background:linear-gradient(180deg,rgba(255,213,77,.10),transparent)}
    .error{border-color:#ff6b6b}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
    .foot{margin-top:18px; font-size:.9rem}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .section-badge{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#101217; border:1px solid rgba(255,255,255,.12); font-size:.85rem; margin-bottom:8px}
    .bar{height:8px; background:#20242c; border-radius:999px; overflow:hidden; margin-bottom:12px}
    .bar>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--brand),var(--brand2)); transition:width .35s ease}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Cheese Wonderland アンケート</h1>
        <div class="muted">所要 <b>2〜3分</b>／匿名・一部任意</div>
      </div>
    </header>

    <div class="card">
      <div class="bar" aria-label="進行状況"><i id="progress"></i></div>
      <form id="form" class="grid" novalidate>
        <!-- 🔒 honeypot for spam -->
        <input type="text" name="website" autocomplete="off" class="sr-only" tabindex="-1" aria-hidden="true">
        <input type="hidden" name="timestamp" id="timestamp">
        <input type="hidden" name="source" id="source">
        <input type="hidden" name="form_version" value="cw_v1.2_ab">

        <!-- STEP A-1: 満足度 -->
        <section class="step active" data-step="1">
          <div class="section-badge">A. 全体評価</div>
          <label>本日の満足度（1〜5）</label>
          <div class="opt" role="radiogroup" aria-label="満足度">
            <input type="radio" id="csat1" name="csat" value="1" required><label for="csat1">1</label>
            <input type="radio" id="csat2" name="csat" value="2"><label for="csat2">2</label>
            <input type="radio" id="csat3" name="csat" value="3"><label for="csat3">3</label>
            <input type="radio" id="csat4" name="csat" value="4"><label for="csat4">4</label>
            <input type="radio" id="csat5" name="csat" value="5"><label for="csat5">5</label>
          </div>
          <p class="help">1=不満 / 5=とても満足</p>
          <div class="btns"><button type="button" class="primary" data-next>次へ</button></div>
        </section>

        <!-- STEP A-2: 勧めたい度 -->
        <section class="step" data-step="2">
          <div class="section-badge">A. 全体評価</div>
          <label>友人に勧めたい度（1〜5）</label>
          <div class="opt" role="radiogroup" aria-label="勧めたい度">
            <input type="radio" id="nps1" name="nps" value="1" required><label for="nps1">1</label>
            <input type="radio" id="nps2" name="nps" value="2"><label for="nps2">2</label>
            <input type="radio" id="nps3" name="nps" value="3"><label for="nps3">3</label>
            <input type="radio" id="nps4" name="nps" value="4"><label for="nps4">4</label>
            <input type="radio" id="nps5" name="nps" value="5"><label for="nps5">5</label>
          </div>
          <div class="btns">
            <button type="button" class="ghost" data-prev>戻る</button>
            <button type="button" class="primary" data-next>次へ</button>
          </div>
        </section>

        <!-- STEP A-3: 次回参加意向 -->
        <section class="step" data-step="3">
          <div class="section-badge">A. 全体評価</div>
          <label>次回も参加したいですか？</label>
          <div class="opt">
            <input type="radio" id="rejoin_yes" name="rejoin" value="はい" required><label for="rejoin_yes">はい</label>
            <input type="radio" id="rejoin_maybe" name="rejoin" value="未定"><label for="rejoin_maybe">未定</label>
            <input type="radio" id="rejoin_no" name="rejoin" value="いいえ"><label for="rejoin_no">いいえ</label>
          </div>
          <div class="btns">
            <button type="button" class="ghost" data-prev>戻る</button>
            <button type="button" class="primary" data-next>次へ</button>
          </div>
        </section>

        <!-- STEP A-4: 価格感 -->
        <section class="step" data-step="4">
          <div class="section-badge">A. 全体評価</div>
          <label>価格の納得感</label>
          <div class="opt">
            <input type="radio" id="price1" name="price_fairness" value="高すぎる" required><label for="price1">高すぎる</label>
            <input type="radio" id="price2" name="price_fairness" value="やや高い"><label for="price2">やや高い</label>
            <input type="radio" id="price3" name="price_fairness" value="ちょうどよい"><label for="price3">ちょうどよい</label>
            <input type="radio" id="price4" name="price_fairness" value="やや安い"><label for="price4">やや安い</label>
            <input type="radio" id="price5" name="price_fairness" value="安すぎる"><label for="price5">安すぎる</label>
          </div>
          <div class="btns">
            <button type="button" class="ghost" data-prev>戻る</button>
            <button type="button" class="primary" data-next>次へ</button>
          </div>
        </section>

        <!-- STEP B-1: ラクレットスライダー -->
        <section class="step" data-step="5">
          <div class="section-badge">B. 各アトラクション</div>
          <label>ラクレットスライダー（1〜5）</label>
          <div class="opt" role="radiogroup">
            <input type="radio" id="rac1" name="raclette_slider" value="1" required><label for="rac1">1</label>
            <input type="radio" id="rac2" name="raclette_slider" value="2"><label for="rac2">2</label>
            <input type="radio" id="rac3" name="raclette_slider" value="3"><label for="rac3">3</label>
            <input type="radio" id="rac4" name="raclette_slider" value="4"><label for="rac4">4</label>
            <input type="radio" id="rac5" name="raclette_slider" value="5"><label for="rac5">5</label>
          </div>
          <div class="btns">
            <button type="button" class="ghost" data-prev>戻る</button>
            <button type="button" class="primary" data-next>次へ</button>
          </div>
        </section>

        <!-- STEP B-2: シカゴウォーターフォール -->
        <section class="step" data-step="6">
          <div class="section-badge">B. 各アトラクション</div>
          <label>シカゴウォーターフォール（1〜5）</label>
          <div class="opt" role="radiogroup">
            <input type="radio" id="cwf1" name="chicago_waterfall" value="1" required><label for="cwf1">1</label>
            <input type="radio" id="cwf2" name="chicago_waterfall" value="2"><label for="cwf2">2</label>
            <input type="radio" id="cwf3" name="chicago_waterfall" value="3"><label for="cwf3">3</label>
            <input type="radio" id="cwf4" name="chicago_waterfall" value="4"><label for="cwf4">4</label>
            <input type="radio" id="cwf5" name="chicago_waterfall" value="5"><label for="cwf5">5</label>
          </div>
          <div class="btns">
            <button type="button" class="ghost" data-prev>戻る</button>
            <button type="button" class="primary" data-next>次へ</button>
          </div>
        </section>

        <!-- STEP B-3: メルティディップポット（チーズフォンデュ） -->
        <section class="step" data-step="7">
          <div class="section-badge">B. 各アトラクション</div>
          <label>メルティディップポット（チーズフォンデュ）（1〜5）</label>
          <div class="opt" role="radiogroup">
            <input type="radio" id="mdp1" name="melty_dip_pot" value="1" required><label for="mdp1">1</label>
            <input type="radio" id="mdp2" name="melty_dip_pot" value="2"><label for="mdp2">2</label>
            <input type="radio" id="mdp3" name="melty_dip_pot" value="3"><label for="mdp3">3</label>
            <input type="radio" id="mdp4" name="melty_dip_pot" value="4"><label for="mdp4">4</label>
            <input type="radio" id="mdp5" name="melty_dip_pot" value="5"><label for="mdp5">5</label>
          </div>
          <div class="btns">
            <button type="button" class="ghost" data-prev>戻る</button>
            <button type="button" class="primary" data-next>次へ</button>
          </div>
        </section>

        <!-- STEP B-4: チーズピザラボ -->
        <section class="step" data-step="8">
          <div class="section-badge">B. 各アトラクション</div>
          <label>チーズピザラボ（1〜5）</label>
          <div class="opt" role="radiogroup">
            <input type="radio" id="cpl1" name="cheese_pizza_lab" value="1" required><label for="cpl1">1</label>
            <input type="radio" id="cpl2" name="cheese_pizza_lab" value="2"><label for="cpl2">2</label>
            <input type="radio" id="cpl3" name="cheese_pizza_lab" value="3"><label for="cpl3">3</label>
            <input type="radio" id="cpl4" name="cheese_pizza_lab" value="4"><label for="cpl4">4</label>
            <input type="radio" id="cpl5" name="cheese_pizza_lab" value="5"><label for="cpl5">5</label>
          </div>
          <div class="btns">
            <button type="button" class="ghost" data-prev>戻る</button>
            <button type="button" class="primary" data-next>次へ</button>
          </div>
        </section>

        <!-- STEP B-5: エスプーマバスク -->
        <section class="step" data-step="9">
          <div class="section-badge">B. 各アトラクション</div>
          <label>エスプーマバスク（1〜5）</label>
          <div class="opt" role="radiogroup">
            <input type="radio" id="eb1" name="espuma_basque" value="1" required><label for="eb1">1</label>
            <input type="radio" id="eb2" name="espuma_basque" value="2"><label for="eb2">2</label>
            <input type="radio" id="eb3" name="espuma_basque" value="3"><label for="eb3">3</label>
            <input type="radio" id="eb4" name="espuma_basque" value="4"><label for="eb4">4</label>
            <input type="radio" id="eb5" name="espuma_basque" value="5"><label for="eb5">5</label>
          </div>
          <div class="btns">
            <button type="button" class="ghost" data-prev>戻る</button>
            <button type="button" class="primary" data-next>次へ</button>
          </div>
        </section>

        <!-- STEP B-6: お気に入り順位 -->
        <section class="step" data-step="10">
          <div class="section-badge">B. 各アトラクション</div>
          <label>お気に入りの順位を選んでください（重複不可）</label>
          <div class="grid">
            <div>
              <span class="help">1位</span>
              <select id="rank1" name="favorite_rank_1" required>
                <option value="">選択してください</option>
                <option>ラクレットスライダー</option>
                <option>シカゴウォーターフォール</option>
                <option>メルティディップポット（チーズフォンデュ）</option>
                <option>チーズピザラボ</option>
                <option>エスプーマバスク</option>
              </select>
            </div>
            <div>
              <span class="help">2位</span>
              <select id="rank2" name="favorite_rank_2" required>
                <option value="">選択してください</option>
                <option>ラクレットスライダー</option>
                <option>シカゴウォーターフォール</option>
                <option>メルティディップポット（チーズフォンデュ）</option>
                <option>チーズピザラボ</option>
                <option>エスプーマバスク</option>
              </select>
            </div>
            <div>
              <span class="help">3位</span>
              <select id="rank3" name="favorite_rank_3" required>
                <option value="">選択してください</option>
                <option>ラクレットスライダー</option>
                <option>シカゴウォーターフォール</option>
                <option>メルティディップポット（チーズフォンデュ）</option>
                <option>チーズピザラボ</option>
                <option>エスプーマバスク</option>
              </select>
            </div>
          </div>
          <div class="btns">
            <button type="button" class="ghost" data-prev>戻る</button>
            <button type="submit" class="primary">送信する</button>
          </div>
        </section>
      </form>
    </div>

    <div id="result" class="card" style="display:none"></div>

    <div class="foot muted">
      匿名でのご協力ありがとうございます。入力内容は改善・品質向上の目的でのみ利用し、個人を特定する利用は行いません。
    </div>
  </div>

  <script>
    // ====== 設定：Formspree の endpoint ======
    const FORMSPREE_ENDPOINT = "https://formspree.io/f/xdkwdvvj"; // ← 指定ID
    const THANKS_COUPON = "CW100"; // 送信後に表示する特典コード（任意）

    // 進行管理
    const steps = Array.from(document.querySelectorAll('.step'));
    let idx = 0; // 現在のステップindex（0開始）
    const progress = document.getElementById('progress');

    function updateProgress(){
      const pct = Math.round(((idx+1)/steps.length)*100);
      progress.style.width = pct + '%';
    }
    function goto(i){
      steps[idx].classList.remove('active');
      idx = i; steps[idx].classList.add('active');
      updateProgress();
      const firstInput = steps[idx].querySelector('input, select, button');
      if(firstInput) firstInput.focus({preventScroll:false});
      window.scrollTo({top:0, behavior:'smooth'});
    }
    document.querySelectorAll('[data-next]').forEach(b=>b.addEventListener('click', ()=>{
      const required = steps[idx].querySelectorAll('[required]');
      for(const el of required){ if(el.type==='radio'){
        const name = el.name; if(!document.querySelector(`input[name="${name}"]:checked`)){ steps[idx].classList.add('error'); setTimeout(()=>steps[idx].classList.remove('error'), 800); return; }
      } else if(el.tagName==='SELECT' && !el.value){ steps[idx].classList.add('error'); setTimeout(()=>steps[idx].classList.remove('error'), 800); return; } }
      goto(Math.min(idx+1, steps.length-1));
    }));
    document.querySelectorAll('[data-prev]').forEach(b=>b.addEventListener('click', ()=> goto(Math.max(idx-1, 0))));

    // タイムスタンプ & source
    document.getElementById('timestamp').value = new Date().toISOString();
    const params = new URLSearchParams(location.search);
    document.getElementById('source').value = params.get('ch') || params.get('utm_source') || '';

    // 順位選択の重複防止
    const selects = ['rank1','rank2','rank3'].map(id=>document.getElementById(id));
    function refreshOptions(){
      const chosen = new Set(selects.map(s=>s.value).filter(v=>v));
      selects.forEach(s=>{
        Array.from(s.options).forEach(o=>{
          if(o.value==='') return; // placeholder
          o.disabled = !o.selected && chosen.has(o.value);
        });
      });
    }
    selects.forEach(s=> s.addEventListener('change', refreshOptions));

    // 送信
    const form = document.getElementById('form');
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      // 必須チェック：Aの4問、Bの5問、順位3つ
      const requiredNames = ['csat','nps','rejoin','price_fairness','raclette_slider','chicago_waterfall','melty_dip_pot','cheese_pizza_lab','espuma_basque'];
      for(const n of requiredNames){ if(!form.querySelector(`[name="${n}"]:checked`)){ alert('未回答の必須項目があります'); return; } }
      for(const id of ['rank1','rank2','rank3']){ if(!document.getElementById(id).value){ alert('お気に入りの順位を選択してください'); return; } }
      // 重複チェック
      const r1 = document.getElementById('rank1').value;
      const r2 = document.getElementById('rank2').value;
      const r3 = document.getElementById('rank3').value;
      if(new Set([r1,r2,r3]).size < 3){ alert('1位・2位・3位は重複しないよう選んでください'); return; }

      const data = new FormData(form);
      try{
        const res = await fetch(FORMSPREE_ENDPOINT, { method:'POST', body:data, headers:{ 'Accept':'application/json' }});
        if(res.ok){
          document.querySelector('.card').style.display='none';
          const result = document.getElementById('result');
          result.style.display='block';
          result.innerHTML = `
            <h2 style="margin:0 0 6px">ご回答ありがとうございました！</h2>
            <p class="muted">皆さまの声をもとに、次回をもっと良くします。</p>
            <div class="pill">特典コード：<span class="mono"><b>${THANKS_COUPON}</b></span></div>
            <p class="help">※ 次回会計時にスタッフへお見せください（期間限定）。</p>
          `;
          localStorage.setItem('cw_survey_submitted','1');
        } else {
          const payload = await res.json().catch(()=>({}));
          throw new Error(payload?.error || '送信に失敗しました。時間を置いてお試しください。');
        }
      } catch(err){
        alert(err.message);
      }
    });

    // 初期化
    updateProgress();

    // 既に送信済みの場合
    if(localStorage.getItem('cw_survey_submitted')==='1'){
      document.querySelector('#result').style.display='block';
      document.querySelector('#result').innerHTML = `<h2>送信ありがとうございました！</h2><p class="muted">再度回答される場合は、ページを再読み込みしてください。</p>`;
      document.querySelector('.card').style.display='none';
    }
  </script>
</body>
</html>
